# lab3 实验报告

## 实验要求

本次实验要求使用访问者模式来实现IR的自动生成，在实验过程中需要阅读cminus-f 的语义规则，助教实现的LightIR实验框架，据此修改补充`src/cminusfc/cminusf_builder.cpp` 来实现 IR 自动产生的算法

## 实验难点

实验中遇到哪些挑战

### 难点1

问题：在完成了节点ASTNum的访问后，如何将得到的值在其他语法树节点使用？

解决方法：引入全局变量cur_value存储上一次所计算的值

### 难点2

问题：如何调用已经预定义的`input`、`output`等函数？

解决方法：在语法树的ASTCall节点中，已经存储了函数的id信息，可以直接调用`scope.find`函数获得

### 难点3

问题：如何处理浮点数与整数运算的问题？

解决方法：在出现浮点数时，将非浮点数转化为浮点数

### 难点4

问题：如何处理函数传递的实参和形参不匹配的问题？

解决方法：将`scope.find`得到的函数转换为(Function *)类型后，调用get_function_type()->param_begin()得到参数类型的迭代器，比较后再对不匹配的类型进行转换

### 难点5

问题：如何声明全局变量

解决方法：使用`GlobalVariable::create`，用`scope.in_global()`判断是否在全局作用域

### 难点6

问题：在选择分支中，如何判断分支内部是否有ret、br语句以完成一个基本块？

解决方法：判断`builder->get_insert_block()->get_terminator()`是否为`nullptr`

### 难点7

问题：如何调用neg_idx_except函数完成负下标索引时的报错？

解决方法：判断下标是否非负，在为负时使用`scope.find("neg_idx_except")`获得neg_idx_except函数

### 难点8

问题：在表达式赋值时，如何获得左值的指针指向的变量的类型？

解决方法：使用`get_type()->get_pointer_element_type()`

### 难点9

问题：比较运算后得到的类型为i1，在之后使用的时候类型不匹配？

解决方法：在比较运算后直接将类型无条件转换为i32

### 难点10

问题：在ASTVar节点的访问中如何获知需要的是否是左值？

解决方法：引入全局变量cur_lvalue在上层节点中传递需要的是否是左值

### 难点11

问题：在ASTVar节点的访问不需要左值时，如何根据指针的类型（如i32，数组）取值？

解决方法：使用`is_integer_type()`/`is_float_type()`/`>is_pointer_type()`获得指针指向的元素类型

## 实验设计

请写明为了顺利完成本次实验，加入了哪些亮点设计，并对这些设计进行解释。
可能的阐述方向有:

1. 如何设计全局变量

   引入了cur_lvalue和cur_value两个值存储此时需要的是否是左值以及当前计算的结果

2. 遇到的难点以及解决方案

   遇到的难点与解决方案见实验难点一节

3. 如何降低生成 IR 中的冗余

   - 在比较运算结束后，直接将结果转换为i32，避免之后使用时的多次转换
   - 在分支语句中，判断是否已经有br/ret语句，避免额外的br/ret语句

4. ...

### 实验总结

在本次试验中，深入理解了cminus-f 的语义规则与访问者模式，对cminus-f 代码转换为IR代码的过程有了更多的理解，同时在阅读助教的代码框架中学习了如何实现一个大的项目框架，以及c++语言中类的多态与智能指针。

### 实验反馈 （可选 不计入评分）

无
